<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>1on1ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯AIï½œå…¥åŠ›ã¨è©•ä¾¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒ‘ã‚¹ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ãã ã•ã„ï¼‰ -->
  <link rel="stylesheet" href="./assets/app.css" />
  <style>
    /* ã“ã“ã«æœ€ä½é™ã®è¦‹ãŸç›®ï¼ˆæ—¢å­˜app.cssã«.cardç­‰ãŒã‚ã‚Œã°ãã‚Œã‚’åˆ©ç”¨ï¼‰ */
    .container { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .muted { color: #6b7280; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 14px; border-radius: 8px; border: 1px solid #d1d5db; background: #111827; color: #fff; cursor: pointer; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .input, textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; }
    textarea { min-height: 180px; }
    .stack { display: grid; gap: 12px; }
    .two { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .section-title { margin: 8px 0; font-weight: 700; }
    .divider { height: 1px; background: #e5e7eb; margin: 16px 0; }
    .pill { display: inline-block; font-size: 12px; padding: 2px 8px; border: 1px solid #e5e7eb; border-radius: 999px; color:#374151;}
  </style>
</head>
<body>
  <div class="container">
    <h1>1on1ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯AIï½œå…¥åŠ›ã¨è©•ä¾¡</h1>
    <p class="muted">ä¼šè©±ãƒ­ã‚°ï¼ˆæ–‡å­—èµ·ã“ã—ï¼‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦è©•ä¾¡ã—ã¾ã™ã€‚</p>

    <div class="row">
      <div class="card" style="flex:2 1 520px;">
        <div class="stack">
          <div class="two">
            <div>
              <label class="section-title">ä¸Šå¸ã®æ°å</label>
              <input id="bossName" class="input" placeholder="ä¾‹ï¼šä¸Šå¸ å¤ªéƒ" />
            </div>
            <div>
              <label class="section-title">å¯¾è±¡ï¼ˆèª°ã¨ã®1on1ï¼‰</label>
              <input id="partnerName" class="input" placeholder="ä¾‹ï¼šéˆ´æœ¨ å›" />
            </div>
          </div>

          <div class="two">
            <div>
              <label class="section-title">ã©ã‚“ãª1on1ï¼ˆç›®çš„ãƒ»ã‚«ãƒ†ã‚´ãƒªï¼‰</label>
              <input id="category" class="input" placeholder="ä¾‹ï¼šç›®æ¨™é€²æ—ã®ç¢ºèªï¼è‚²æˆ" />
            </div>
            <div>
              <label class="section-title">æ–‡å­—èµ·ã“ã—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä»»æ„ï¼‰</label>
              <input id="transcriptFile" type="file" accept=".txt,.md,.csv,.vtt,.srt,.docx,.pdf" />
            </div>
          </div>

          <div>
            <label class="section-title">ä¼šè©±ãƒ­ã‚°ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè²¼ã‚Šä»˜ã‘ï¼‰</label>
            <textarea id="transcriptText" placeholder="ã“ã“ã«ä¼šè©±ãƒ­ã‚°ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¾ã™"></textarea>
          </div>

          <div class="row" style="align-items:center; justify-content: space-between;">
            <div class="muted">
              <span class="pill">PoC</span>
              <span class="pill">éè¨€èªæƒ…å ±ã¯æœªä½¿ç”¨</span>
              <span class="pill">ç¤¾å†…é™å®š</span>
            </div>
            <div class="row" style="gap:8px;">
              <button class="btn" id="btnEvaluate">è©•ä¾¡ã™ã‚‹</button>
              <button class="btn" id="btnSave" disabled>ä¿å­˜ã™ã‚‹</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="flex:1 1 320px;">
        <div class="stack">
          <div><strong>é€²è¡ŒçŠ¶æ³</strong></div>
          <div id="status" class="muted">å¾…æ©Ÿä¸­</div>
          <div class="divider"></div>
          <div><strong>å®šé‡ï¼ˆç®—å‡ºï¼‰</strong></div>
          <div class="muted" id="scoreSummary">â€”</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2 style="margin-top:0;">å®šæ€§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h2>
      <div id="qualitativeResult" class="stack"></div>
    </div>
  </div>

  <!-- Supabase SDKï¼ˆãƒ‘ã‚¹ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®libsã«åˆã‚ã›ã¦ãã ã•ã„ï¼‰ -->
  <script src="./libs/supabase.min.js"></script>
  <!-- ã‚¢ãƒ—ãƒªå…±é€šï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ä¿æŒã‚„ sb ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ãŒã‚ã‚‹æƒ³å®šï¼‰ -->
  <script src="./assets/app-shell.js"></script>

  <script>
    /**
     * ===== è¨­å®šï¼ˆç¤¾å†…PoCå‘ã‘ã«ãƒ•ãƒ­ãƒ³ãƒˆç›´æ›¸ãï¼‰=====
     * Difyã®App APIã‚­ãƒ¼ã¨ãƒ™ãƒ¼ã‚¹URLã€‚
     * æ³¨æ„ï¼šå•†ç”¨åŒ–æ™‚ã¯Edge Functionç­‰ã§ç§˜åŒ¿ã—ã¦ãã ã•ã„ã€‚
     */
    const DIFY_API_BASE = "https://api.dify.ai/v1";
    const DIFY_API_KEY  = "app-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; // â† è‡ªç¤¾ã®Dify App Key

    /**
     * Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ app-shell.js å´ã§ window.sb ã¨ã—ã¦åˆæœŸåŒ–æ¸ˆã¿ã®æƒ³å®šã§ã™ã€‚
     * ã‚‚ã—æœªè¨­å®šãªã‚‰ä¸‹è¨˜ã®ã‚ˆã†ã«åˆæœŸåŒ–ã—ã¦ãã ã•ã„ï¼š
     * window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
     */

    // ç”»é¢çŠ¶æ…‹ã®å‚ç…§
    const el = {
      bossName:       document.getElementById('bossName'),
      partnerName:    document.getElementById('partnerName'),
      category:       document.getElementById('category'),
      transcriptFile: document.getElementById('transcriptFile'),
      transcriptText: document.getElementById('transcriptText'),
      btnEvaluate:    document.getElementById('btnEvaluate'),
      btnSave:        document.getElementById('btnSave'),
      status:         document.getElementById('status'),
      scoreSummary:   document.getElementById('scoreSummary'),
      qualitative:    document.getElementById('qualitativeResult'),
    };

    // ç›´è¿‘ã®çµæœï¼ˆä¿å­˜æ™‚ã«ä½¿ã†ï¼‰
    window.__latest_feedback_text = null; // Difyã®å®šæ€§æœ¬æ–‡ï¼ˆä¸¸ã”ã¨ï¼‰
    window.__latest_sections      = null; // {good:[], better:[], habits:[]}
    window.__latest_values        = null; // Difyã®ç”Ÿå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    window.__latest_scores        = null; // {coaching, listening, technique, next_step, total}

    // -------------------------
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆUIï¼‰
    // -------------------------
    function setBusy(busy) {
      el.btnEvaluate.disabled = busy;
      el.btnSave.disabled     = busy || !window.__latest_scores;
      el.status.textContent   = busy ? "è©•ä¾¡ä¸­â€¦" : "å¾…æ©Ÿä¸­";
    }

    function renderQualitativeCards(container, sections) {
      container.innerHTML = '';
      const makeCard = (title, items) => {
        if (!items || items.length === 0) return null;
        const card = document.createElement('div');
        card.className = 'card';
        const h3 = document.createElement('h3');
        h3.textContent = title;
        h3.style.marginTop = '0';
        h3.style.marginBottom = '8px';
        const ul = document.createElement('ul');
        ul.style.paddingLeft = '1.2em';
        (items || []).forEach(t => {
          const li = document.createElement('li');
          li.textContent = t;
          ul.appendChild(li);
        });
        card.appendChild(h3);
        card.appendChild(ul);
        return card;
      };

      const good   = makeCard('ã€è‰¯ã„ç‚¹âœ¨ã€‘', sections.good);
      const better = makeCard('ã€ã‚‚ã£ã¨è‰¯ããªã‚‹ç‚¹ğŸ’¡ã€‘', sections.better);
      const habits = makeCard('ã€7ã¤ã®ç¿’æ…£ã®è¦³ç‚¹ğŸ“˜ã€‘', sections.habits);
      [good, better, habits].forEach(c => c && container.appendChild(c));

      if (!good && !better && !habits) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'ç‰¹ç­†ã™ã¹ãå®šæ€§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
        container.appendChild(empty);
      }
    }

    function parseDifyTextToSections(text) {
      const pick = (label) => {
        const r = new RegExp(`ã€${label}ã€‘([\\s\\S]*?)(?=\\n\\s*ã€|\\s*$)`, 'm');
        const m = text.match(r);
        if (!m) return [];
        const block = m[1].trim();
        const lines = block.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        const items = [];
        for (const line of lines) {
          const mm = line.match(/^(?:ãƒ»|-|\\*|\\d+\\.)\\s*(.+)$/);
          items.push(mm ? mm[1] : line);
        }
        return items;
      };
      return {
        good:   pick('è‰¯ã„ç‚¹âœ¨'),
        better: pick('ã‚‚ã£ã¨è‰¯ããªã‚‹ç‚¹ğŸ’¡'),
        habits: pick('7ã¤ã®ç¿’æ…£ã®è¦³ç‚¹ğŸ“˜'),
      };
    }

    // -------------------------
    // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆä»•æ§˜ã«æ²¿ã£ã¦ï¼‰
    // -------------------------
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function calcScoresFromValues(values){
      // values ãŒç„¡ã„å ´åˆã®ä¿é™º
      if (!values) {
        return { coaching: 0, listening: 0, technique: 0, next_step: 0, total: 0 };
      }

      // å—ã‘å–ã‚Šã®æƒ³å®šï¼š
      // values = {
      //   open_question_rate: 0.5,
      //   subordinate_talk_ratio: 0.6,
      //   reflection_count: 3,
      //   good: { coaching: 2, listening: 1, technique: 1 },
      //   bad:  { coaching: 0, listening: 0, technique: 0 },
      //   next: { touched:1, what:1, when:1 }
      //   matched_ids: { good:[...], bad:[...], habits:[...] } // ä¿å­˜ç”¨(å‚è€ƒ)
      // }

      const oq = Number(values.open_question_rate ?? 0);     // 0ã€œ1
      const st = Number(values.subordinate_talk_ratio ?? 0); // 0ã€œ1
      const rc = Number(values.reflection_count ?? 0);       // å›æ•°ï¼ˆæ•´æ•°ï¼‰
      const good = values.good || {};
      const bad  = values.bad  || {};
      const nxt  = values.next || {};

      // (1) ã‚³ãƒ¼ãƒãƒ³ã‚°çš„æŒ‡å°ï¼ˆMAX 40ï¼‰
      const scoreA = Math.min(20, (oq / 0.30) * 20);
      const scoreB = st >= 0.60 ? 20 : 20 * (st / 0.60);
      const scoreC = clamp(
        (Number(good.coaching ?? 0) - Number(bad.coaching ?? 0)) * 1,
        -20, 20
      );
      const coaching = clamp(scoreA + scoreB + scoreC, 0, 40);

      // (2) å‚¾è´ãƒ»å…±æ„Ÿï¼ˆMAX 30ï¼‰
      const listenA = Math.min(30, (rc / 3) * 30);
      const listenB = clamp(
        (Number(good.listening ?? 0) * 1) - (Number(bad.listening ?? 0) * 3),
        -20, 6
      );
      const listening = clamp(listenA + listenB, 0, 30);

      // (3) æŒ‡å°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼ˆMAX 20ã€åº•ä¸Šã’+10ï¼‰
      const technique = clamp(10 + (Number(good.technique ?? 0) - Number(bad.technique ?? 0)), 0, 20);

      // (4) æ¬¡ã®ä¸€æ‰‹ï¼ˆMAX 10ï¼‰
      const next_step = clamp(
        3 * Number(nxt.touched ? 1 : 0) +
        4 * Number(nxt.what ? 1 : 0) +
        3 * Number(nxt.when ? 1 : 0),
        0, 10
      );

      const total = clamp(coaching + listening + technique + next_step, 0, 100);

      return { coaching: Math.round(coaching), listening: Math.round(listening), technique: Math.round(technique), next_step: Math.round(next_step), total: Math.round(total) };
    }

    function updateScoreSummary(scores){
      if (!scores) { el.scoreSummary.textContent = 'â€”'; return; }
      el.scoreSummary.textContent =
        `TOTAL ${scores.total} /100  ï½œ ã‚³ãƒ¼ãƒãƒ³ã‚° ${scores.coaching}/40 ï½œ å‚¾è´ ${scores.listening}/30 ï½œ ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ ${scores.technique}/20 ï½œ æ¬¡ã®ä¸€æ‰‹ ${scores.next_step}/10`;
    }

    // -------------------------
    // Supabaseï¼šã‚¢ãƒ—ãƒªåˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    // ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿å‰æã€‚users ã¯ app ã‚¹ã‚­ãƒ¼ãƒï¼‰
    // -------------------------
    async function getMyAppUserId(){
      const { data: { user }, error: authErr } = await window.sb.auth.getUser();
      if (authErr || !user) throw new Error("ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã€‚");
      // æ—¢ã«ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿åˆ©ç”¨ã™ã‚‹æ–¹é‡ â†’ æ¤œå‡ºã§ããªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
      const { data, error } = await window.sb
        .from('users', { schema: 'app' })
        .select('user_id')
        .eq('auth_user_id', user.id)
        .single();
      if (error || !data) throw new Error("ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã‚¢ãƒ—ãƒªåˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã¸é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
      return data.user_id;
    }

    // -------------------------
    // Difyå‘¼ã³å‡ºã—ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«â†’IDåŒ–ã€ãƒ†ã‚­ã‚¹ãƒˆè©•ä¾¡ï¼‰
    // -------------------------
    async function uploadFileToDify(file){
      const form = new FormData();
      form.append('file', file);
      // Difyã® /files
      const res = await fetch(`${DIFY_API_BASE}/files`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${DIFY_API_KEY}` },
        body: form
      });
      if (!res.ok) throw new Error(`Difyãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—: ${res.status}`);
      return res.json(); // { id, ... }
    }

    async function callDifyEvaluate({text, fileId, meta}){
      // response_mode: "blocking" ã§ä¸€æ‹¬å—ä¿¡
      const body = {
        inputs: {
          boss_name:    meta.bossName || '',
          partner_name: meta.partnerName || '',
          category:     meta.category || '',
          transcript:   text || '',
          file_id:      fileId || ''
        },
        query: '1on1ã®è©•ä¾¡ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',
        user: meta.user || 'demo-user',
        response_mode: 'blocking'
      };
      const res = await fetch(`${DIFY_API_BASE}/chat-messages`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${DIFY_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error(`Difyè©•ä¾¡ã«å¤±æ•—: ${res.status}`);
      return res.json();
    }

    // -------------------------
    // è©•ä¾¡ â†’ ç”»é¢æç”»
    // -------------------------
    async function handleDifyResponseAndRender(difyRes) {
      const text   = (difyRes?.answer ?? difyRes?.data?.answer ?? '').trim();
      const values = (difyRes?.data?.values ?? difyRes?.values ?? null);

      const sections = parseDifyTextToSections(text);
      renderQualitativeCards(el.qualitative, sections);

      const scores = calcScoresFromValues(values);
      updateScoreSummary(scores);

      // ä¿å­˜ç”¨ã«ä¿æŒ
      window.__latest_feedback_text = text;
      window.__latest_sections      = sections;
      window.__latest_values        = values;
      window.__latest_scores        = scores;

      // ä¿å­˜ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
      el.btnSave.disabled = !scores;
    }

    // -------------------------
    // ä¿å­˜å‡¦ç†ï¼ˆsessions â†’ session_feedbacks â†’ usageï¼‰
    // -------------------------
    async function saveAll(){
      const user_id = await getMyAppUserId();

      // 1) sessions
      const sessionInsert = await window.sb
        .from('sessions', { schema: 'app' })
        .insert([{
          user_id,
          category: el.category.value || null,
          values_json: window.__latest_values || {},
          scores_json: window.__latest_scores || {}
        }])
        .select('session_id, created_at')
        .single();
      if (sessionInsert.error) throw sessionInsert.error;
      const session_id = sessionInsert.data.session_id;

      // 2) session_feedbacksï¼ˆå®šæ€§ï¼‰
      const s = window.__latest_sections || { good:[], better:[], habits:[] };
      const joinOrNull = (arr) => (arr && arr.length ? arr.map(v=>`ãƒ»${v}`).join('\n') : null);
      const fbInsert = await window.sb
        .from('session_feedbacks', { schema: 'app' })
        .insert([{
          session_id,
          good_points:   joinOrNull(s.good),
          better_points: joinOrNull(s.better),
          seven_habits:  joinOrNull(s.habits),
          raw_json:      { text: window.__latest_feedback_text }
        }])
        .select('id')
        .single();
      if (fbInsert.error) throw fbInsert.error;

      // 3) usageï¼ˆç›£æŸ»ç”¨ï¼‰
      const usageInsert = await window.sb
        .from('usage', { schema: 'app' })
        .insert([{ user_id, session_id }])
        .select('id')
        .single();
      if (usageInsert.error) {
        // usageã¯å¤±æ•—ã—ã¦ã‚‚è‡´å‘½ã§ã¯ãªã„ã®ã§ãƒ­ã‚°ã ã‘
        console.warn('usage insert failed:', usageInsert.error);
      }

      return { session_id };
    }

    // -------------------------
    // ã‚¤ãƒ™ãƒ³ãƒˆ
    // -------------------------
    el.btnEvaluate.addEventListener('click', async () => {
      try {
        setBusy(true);
        el.qualitative.innerHTML = '';
        el.scoreSummary.textContent = 'â€”';

        // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªï¼ˆä¿å­˜å‰ã«ä¸€åº¦è¦‹ã¦ãŠãï¼‰
        await getMyAppUserId();

        // å…¥åŠ›ã‚’å›å
        const bossName    = el.bossName.value.trim();
        const partnerName = el.partnerName.value.trim();
        const category    = el.category.value.trim();
        const text        = el.transcriptText.value.trim();
        const file        = el.transcriptFile.files[0];

        if (!text && !file) {
          alert('ä¼šè©±ãƒ­ã‚°ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°Difyã«ã‚¢ãƒƒãƒ—
        let fileId = '';
        if (file) {
          el.status.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦';
          const up = await uploadFileToDify(file);
          fileId = up?.id || '';
        }

        // è©•ä¾¡
        el.status.textContent = 'è©•ä¾¡ä¸­â€¦';
        const { data: { user } } = await window.sb.auth.getUser();
        const difyRes = await callDifyEvaluate({
          text,
          fileId,
          meta: {
            bossName, partnerName, category,
            user: user?.id || 'demo-user'
          }
        });

        await handleDifyResponseAndRender(difyRes);
        el.status.textContent = 'è©•ä¾¡å®Œäº†';
      } catch (e) {
        console.error(e);
        alert(`è©•ä¾¡ã§ã‚¨ãƒ©ãƒ¼ï¼š${e.message || e}`);
        el.status.textContent = 'ã‚¨ãƒ©ãƒ¼';
      } finally {
        setBusy(false);
      }
    });

    el.btnSave.addEventListener('click', async () => {
      try {
        setBusy(true);
        el.status.textContent = 'ä¿å­˜ä¸­â€¦';

        if (!window.__latest_scores) {
          alert('å…ˆã«è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        const { session_id } = await saveAll();

        el.status.textContent = `ä¿å­˜å®Œäº†ï¼ˆsession_id: ${session_id}ï¼‰`;
        // æ¬¡ç”»é¢ã¸ã®é·ç§»ã¯å¿…è¦ã«å¿œã˜ã¦ï¼š
        // location.href = './feedbacklog.html';
      } catch (e) {
        console.error(e);
        alert(`ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ï¼š${e.message || e}`);
        el.status.textContent = 'ã‚¨ãƒ©ãƒ¼';
      } finally {
        setBusy(false);
      }
    });

  </script>
</body>
</html>

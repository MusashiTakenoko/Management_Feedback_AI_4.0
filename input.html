<!doctype html><html lang="ja"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ãƒ­ã‚°å…¥åŠ› | 1on1ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯AI</title>
<link rel="stylesheet" href="app.css">
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
</head><body>
<div id="app-root">
  <main id="content" class="content">
    <div class="grid2">
      <section class="card"><div class="body">
        <h2 style="margin:0 0 6px">ãƒ­ã‚°å…¥åŠ›ï¼ˆè©•ä¾¡ï¼‰</h2>
        <p class="hint">æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã€è©•ä¾¡â†’ä¿å­˜ã¾ã§è¡Œã„ã¾ã™ã€‚</p>
        <label for="name">æ°åï¼ˆå¿…é ˆï¼‰</label>
        <input id="name" type="text" placeholder="ä¾‹ï¼šæ²³é‡ã•ã‚“" required>
        <label for="relation">èª°ã¨ã®1on1ï¼ˆé–¢ä¿‚æ€§ï¼‰</label>
        <input id="relation" type="text" placeholder="ä¾‹ï¼šå–¶æ¥­éƒ¨ã®éƒ¨ä¸‹Aï¼ˆå…¥ç¤¾2å¹´ç›®ï¼‰">
        <label for="category">ã©ã‚“ãª1on1ï¼ˆç›®çš„ãƒ»ã‚«ãƒ†ã‚´ãƒªï¼‰</label>
        <input id="category" type="text" placeholder="ä¾‹ï¼šâ‘¡ æ¥­å‹™é€²æ—ãƒ»æˆæœç®¡ç†ç³»">
        <label for="transcript">ä¼šè©±ãƒ­ã‚°ï¼ˆæ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
        <textarea id="transcript" placeholder="ã“ã“ã«ä¼šè©±ãƒ­ã‚°ã‚’è²¼ã‚Šä»˜ã‘"></textarea>

        <div class="row" style="margin-top:8px;flex-wrap:wrap">
          <input type="file" id="fileInput" style="max-width:280px">
          <button class="btn btn-ghost" id="uploadBtn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Difyã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
          <span class="hint" id="uploadStatus"></span>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="btn btn-primary" id="startEvalBtn">é€ä¿¡ã—ã¦è©•ä¾¡ã‚’é–‹å§‹</button>
          <span class="hint" id="statusLine"></span>
        </div>
      </div></section>

      <section class="card"><div class="body" id="resultArea" style="display:none">
        <div><span class="pill">å®šæ€§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span></div>
        <h3 class="hint" style="margin:8px 0 0">è‰¯ã„ç‚¹âœ¨</h3>
        <ul class="clean" id="goodList"></ul>
        <h3 class="hint" style="margin:8px 0 0">ã‚‚ã£ã¨è‰¯ããªã‚‹ç‚¹ğŸ’¡</h3>
        <ul class="clean" id="betterList"></ul>
        <h3 class="hint" id="habitsTitle" style="display:none;margin:8px 0 0">7ã¤ã®ç¿’æ…£ã®è¦³ç‚¹ğŸ“˜</h3>
        <ul class="clean" id="habitsList"></ul>

        <div style="margin-top:10px"><span class="pill">å®šé‡ã‚¹ã‚³ã‚¢</span></div>
        <div class="scorebox" style="margin-top:8px">
          <div class="score"><div class="name">TOTAL</div><div id="sTOTAL" class="val">-</div></div>
          <div class="score"><div class="name">ã‚³ãƒ¼ãƒãƒ³ã‚°</div><div id="sCO" class="val">-</div></div>
          <div class="score"><div class="name">å‚¾è´ãƒ»å…±æ„Ÿ</div><div id="sLI" class="val">-</div></div>
          <div class="score"><div class="name">ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯</div><div id="sTE" class="val">-</div></div>
          <div class="score"><div class="name">æ¬¡ã®ä¸€æ‰‹</div><div id="sNE" class="val">-</div></div>
        </div>
        <p class="hint">â€»ã‚¹ã‚³ã‚¢ã¯æš«å®šçš„ã«ãƒ•ãƒ­ãƒ³ãƒˆã§è¨ˆç®—ã€‚å°†æ¥ã¯Edge Functionã¸ç§»è¡Œã€‚</p>

        <div class="row" style="margin-top:8px">
          <button class="btn btn-primary" id="saveBtn">Supabaseã¸ä¿å­˜</button>
          <span class="hint" id="saveStatus"></span>
        </div>
      </div></section>
    </div>
  </main>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="app-shell.js"></script>
<script>
  AppShell.mountShell();
</script>

<!-- Dify + ã‚¹ã‚³ã‚¢ + ä¿å­˜ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’window.sbã§å‹•ãã‚ˆã†ã«ï¼‰ -->
<script>
const DIFY_API_BASE="https://api.dify.ai/v1";
const DIFY_API_KEY="app-oQ6FrskTeh3kjOopzVmm44pq";

let conversationId=null;
let lastUploadedFileId=null;
let currentUser=null;

const $good = document.getElementById('goodList');
const $better = document.getElementById('betterList');
const $habits = document.getElementById('habitsList');
const $habitsTitle = document.getElementById('habitsTitle');
const $resultArea = document.getElementById('resultArea');
const $statusLine = document.getElementById('statusLine');
const $saveStatus = document.getElementById('saveStatus');
const scoreEls = {
  total: document.getElementById('sTOTAL'),
  coaching: document.getElementById('sCO'),
  listening: document.getElementById('sLI'),
  technique: document.getElementById('sTE'),
  next: document.getElementById('sNE'),
};
const clamp = (v,lo,hi)=>Math.max(lo,Math.min(hi,v));
function li(listEl,items){ listEl.innerHTML=""; (items||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; listEl.appendChild(li); }); }
function colorize(el, v, max){
  if(v==null){ el.textContent="-"; return; }
  el.textContent = v.toFixed(0);
  el.classList.remove('ok','warn','bad');
  const r=v/max;
  if(r>=0.8) el.classList.add('ok'); else if(r>=0.5) el.classList.add('warn'); else el.classList.add('bad');
}

(async()=>{ const { data:{ user } } = await window.sb.auth.getUser(); currentUser=user; })();

document.getElementById("uploadBtn").addEventListener("click", async ()=>{
  const file = document.getElementById("fileInput").files[0];
  const status = document.getElementById("uploadStatus");
  if(!file){ alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  try{
    status.textContent="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦";
    const form=new FormData(); form.append("file",file);
    const res=await fetch(`${DIFY_API_BASE}/files`,{method:"POST",headers:{ "Authorization":`Bearer ${DIFY_API_KEY}` },body:form});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json(); lastUploadedFileId=data.id; status.textContent="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº† âœ“";
  }catch(e){ status.textContent="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—"; }
});

document.getElementById("startEvalBtn").addEventListener("click", async ()=>{
  const name=document.getElementById("name").value.trim();
  if(!name){ alert("æ°åã¯å¿…é ˆã§ã™"); return; }
  const relation=document.getElementById("relation").value.trim();
  const category=document.getElementById("category").value.trim();
  const transcript=document.getElementById("transcript").value.trim();
  const query=[`æ°åï¼š${name}`, relation?`å‚åŠ è€…ï¼š${relation}`:"", category?`ç¨®åˆ¥ï¼š${category}`:"", transcript?`ä¼šè©±ãƒ­ã‚°ï¼š\n${transcript}`:""].filter(Boolean).join("\n\n");

  $statusLine.textContent="Difyã«é€ä¿¡ä¸­â€¦";
  try{
    const files=[]; if(lastUploadedFileId){ files.push({type:"file",transfer_method:"local",upload_file_id:lastUploadedFileId}); }
    const body={ inputs:{}, query, user: currentUser?.id || "demo-user", response_mode:"blocking", conversation_id:conversationId, files };
    const res=await fetch(`${DIFY_API_BASE}/chat-messages`,{ method:"POST", headers:{ "Authorization":`Bearer ${DIFY_API_KEY}`,"Content-Type":"application/json" }, body:JSON.stringify(body) });
    const text=await res.text(); if(!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
    const data=JSON.parse(text); conversationId=data.conversation_id||conversationId;
    const answer=data.answer||"";
    const parsed=parseFeedback(answer);
    const values=parsed.values||{};
    const scores=computeScoresFromValues(values);

    $resultArea.style.display="block";
    li($good, parsed.good); li($better, parsed.better);
    if(parsed.habits && parsed.habits.length){ $habitsTitle.style.display="block"; li($habits, parsed.habits); } else { $habitsTitle.style.display="none"; $habits.innerHTML=""; }
    colorize(scoreEls.total, scores.total, 100);
    colorize(scoreEls.coaching, scores.coaching, 40);
    colorize(scoreEls.listening, scores.listening, 30);
    colorize(scoreEls.technique, scores.technique, 20);
    colorize(scoreEls.next, scores.next_step, 10);

    $saveStatus.textContent="";
    document.getElementById("saveBtn").onclick = ()=> saveAllToDB({
      category,
      rawFromDify:{ text:answer, good:parsed.good, better:parsed.better, sevenHabits:parsed.habits, values },
      values, scores
    });

    $statusLine.textContent="è©•ä¾¡å®Œäº†ã€‚å¿…è¦ãªã‚‰ã€ä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
  }catch(e){ console.error(e); $statusLine.textContent="ã‚¨ãƒ©ãƒ¼: "+e.message; }
});

function parseFeedback(text){
  const result={good:[], better:[], habits:[], values:null};
  try{
    const m = text.split("===JSON===")[1];
    if(m){ const j=JSON.parse(m.trim()); if(j.values) result.values=j.values; }
    else{
      const jm = text.match(/\{[\s\S]*\}$/); if(jm){ const j=JSON.parse(jm[0]); if(j.values) result.values=j.values; }
    }
  }catch{}
  const g=splitSection(text,/ã€?è‰¯ã„ç‚¹.*?ã€‘?/);
  const b=splitSection(text,/ã€?ã‚‚ã£ã¨è‰¯ããªã‚‹ç‚¹.*?ã€‘?/);
  const h=splitSection(text,/ã€?7ã¤ã®ç¿’æ…£.*?ã€‘?/);
  result.good = bullets(g); result.better = bullets(b); result.habits = bullets(h);
  return result;

  function splitSection(t,re){ const idx=t.search(re); if(idx===-1) return ""; const after=t.slice(idx); const next=after.search(/ã€?ã‚‚ã£ã¨è‰¯ããªã‚‹ç‚¹.*?ã€‘?|ã€?7ã¤ã®ç¿’æ…£.*?ã€‘?/); return next>0? after.slice(0,next) : after; }
  function bullets(block){
    if(!block) return [];
    const lines=block.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    let arr=[]; for(const s of lines){ const m=s.match(/^(?:[-ãƒ»*]|[0-9]+\.)\s*(.*)$/); arr.push(m?m[1]:s); }
    return Array.from(new Set(arr.filter(x=>!x.includes("è‰¯ã„ç‚¹")&&!x.includes("ã‚‚ã£ã¨è‰¯ããªã‚‹ç‚¹")&&!x.includes("7ã¤ã®ç¿’æ…£"))));
  }
}
function computeScoresFromValues(v){
  const openRate=Number(v.open_question_rate??0);
  const talkRatio=Number(v.subordinate_talk_ratio??0);
  const refl=Number(v.reflection_count??0);
  const good=v.good||{coaching:0,listening:0,technique:0};
  const bad=v.bad||{coaching:0,listening:0,technique:0};
  const nxt=v.next||{touched:0,what:0,when:0};
  const A1=Math.min(20,(openRate/0.30)*20);
  const B1=(talkRatio>=0.60)?20:20*(talkRatio/0.60);
  const C1=clamp((+1*Number(good.coaching||0))-(1*Number(bad.coaching||0)),-20,20);
  const coaching=clamp(A1+B1+C1,0,40);
  const A2=Math.min(30,(refl/3)*30);
  const B2=clamp((+1*Number(good.listening||0))-(3*Number(bad.listening||0)),-20,6);
  const listening=clamp(A2+B2,0,30);
  const technique=clamp(10+(Number(good.technique||0))-(Number(bad.technique||0)),0,20);
  const next_step=clamp(3*(nxt.touched?1:0)+4*(nxt.what?1:0)+3*(nxt.when?1:0),0,10);
  const total=coaching+listening+technique+next_step;
  return { coaching, listening, technique, next_step, total };
}
async function getMyAppUserId(){
  const { data:{ user } } = await window.sb.auth.getUser();
  const { data, error } = await window.sb.from('users',{schema:'app'}).select('user_id').eq('auth_user_id', user.id).single();
  if(error) throw error; return data.user_id;
}
async function createSession({ category, values_json, scores_json }){
  const myId = await getMyAppUserId();
  const { data, error } = await window.sb.from('sessions',{schema:'app'}).insert([{ user_id:myId, category, values_json, scores_json }]).select('session_id').single();
  if(error) throw error; return data.session_id;
}
async function saveFeedback(session_id, { good_points, better_points, seven_habits, raw_json }){
  const { error } = await window.sb.from('session_feedbacks',{schema:'app'}).insert([{ session_id, good_points, better_points, seven_habits, raw_json }]);
  if(error) throw error;
}
async function saveAllToDB({ category, rawFromDify, values, scores }){
  try{
    $saveStatus.textContent="ä¿å­˜ä¸­â€¦";
    const gp=(rawFromDify.good||[]).map(s=>`- ${s}`).join("\n");
    const bp=(rawFromDify.better||[]).map(s=>`- ${s}`).join("\n");
    const sh=(rawFromDify.sevenHabits||[]).map(s=>`- ${s}`).join("\n");
    const sessionId=await createSession({ category, values_json:values, scores_json:scores });
    await saveFeedback(sessionId,{ good_points:gp, better_points:bp, seven_habits:sh, raw_json:rawFromDify });
    const myId=await getMyAppUserId();
    await window.sb.from('usage',{schema:'app'}).insert([{ user_id:myId, session_id:sessionId }]);
    $saveStatus.textContent="ä¿å­˜ã—ã¾ã—ãŸ âœ“";
  }catch(e){ console.error(e); $saveStatus.textContent="ä¿å­˜ã‚¨ãƒ©ãƒ¼: "+e.message; }
}
</script>
</body></html>

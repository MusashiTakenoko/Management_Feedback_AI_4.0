<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ­ã‚°å…¥åŠ› | 1on1ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯AI</title>

  <!-- åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹CSSã‚’èª­ã‚€ï¼ˆãƒ‘ã‚¹ãšã‚Œæ³¨æ„ï¼‰ -->
  <link rel="stylesheet" href="./app.css" />
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* è¿½åŠ ã®ä¿é™ºï¼ˆæ—¢å­˜app.cssã®ä¸Šã«è»½ãè¶³ã™ï¼‰ */
    .grid2 { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; }
    @media (max-width: 980px) { .grid2 { grid-template-columns: 1fr; } }
    .card { border-radius: 12px; border: 1px solid #e5e7eb; background: #fff; }
    .card .body { padding: 16px; }
    .row { display: flex; align-items: center; gap: 8px; }
    .btn { cursor: pointer; border-radius: 8px; padding: 8px 12px; border: 1px solid #d1d5db; }
    .btn-primary { background: #111827; color:#fff; }
    .btn-ghost { background: #f9fafb; }
    .hint { color:#6b7280; font-size: 12px; }
    .pill { display:inline-block; font-size: 12px; padding: 2px 8px; border-radius: 999px; border:1px solid #e5e7eb; color:#374151; }
    .scorebox { display:grid; grid-template-columns: repeat(auto-fit,minmax(120px,1fr)); gap:8px; }
    .score { padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fafafa; }
    .score .name { font-size:12px; color:#6b7280; }
    .score .val { font-size:20px; font-weight:700; }
    .val.ok { color:#047857; } .val.warn { color:#b45309; } .val.bad { color:#b91c1c; }
    ul.clean { margin:0; }
  </style>
</head>
<body>
  <div id="app-root">
    <main id="content" class="content">
      <div class="grid2">
        <!-- å…¥åŠ› -->
        <section class="card">
          <div class="body">
            <h2 style="margin:0 0 6px">ãƒ­ã‚°å…¥åŠ›ï¼ˆè©•ä¾¡ï¼‰</h2>
            <p class="hint">æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã€è©•ä¾¡â†’ä¿å­˜ã¾ã§è¡Œã„ã¾ã™ã€‚</p>

            <label for="name">æ°åï¼ˆå¿…é ˆï¼‰</label>
            <input id="name" type="text" placeholder="ä¾‹ï¼šæ²³é‡ã•ã‚“" required>

            <label for="relation">èª°ã¨ã®1on1ï¼ˆé–¢ä¿‚æ€§ï¼‰</label>
            <input id="relation" type="text" placeholder="ä¾‹ï¼šå–¶æ¥­éƒ¨ã®éƒ¨ä¸‹Aï¼ˆå…¥ç¤¾2å¹´ç›®ï¼‰">

            <label for="category">ã©ã‚“ãª1on1ï¼ˆç›®çš„ãƒ»ã‚«ãƒ†ã‚´ãƒªï¼‰</label>
            <input id="category" type="text" placeholder="ä¾‹ï¼šâ‘¡ æ¥­å‹™é€²æ—ãƒ»æˆæœç®¡ç†ç³»">

            <label for="transcript">ä¼šè©±ãƒ­ã‚°ï¼ˆæ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
            <textarea id="transcript" placeholder="ã“ã“ã«ä¼šè©±ãƒ­ã‚°ã‚’è²¼ã‚Šä»˜ã‘"></textarea>

            <div class="row" style="margin-top:8px;flex-wrap:wrap">
              <input type="file" id="fileInput" style="max-width:280px">
              <button class="btn btn-ghost" id="uploadBtn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Difyã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
              <span class="hint" id="uploadStatus"></span>
            </div>

            <div class="row" style="margin-top:8px">
              <button class="btn btn-primary" id="startEvalBtn">é€ä¿¡ã—ã¦è©•ä¾¡ã‚’é–‹å§‹</button>
              <span class="hint" id="statusLine"></span>
            </div>
          </div>
        </section>

        <!-- å‡ºåŠ›ï¼ˆJSONã¯è¡¨ç¤ºã—ãªã„ï¼3ã‚«ãƒ¼ãƒ‰æç”»ï¼‰ -->
        <section class="card">
          <div class="body" id="resultArea" style="display:none">
            <div><span class="pill">å®šæ€§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span></div>

            <!-- 3ã‚«ãƒ¼ãƒ‰ã‚’JSã§å·®ã—è¾¼ã‚€ -->
            <div id="qualCards" style="margin-top:10px; display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px;"></div>

            <div style="margin-top:14px"><span class="pill">å®šé‡ã‚¹ã‚³ã‚¢</span></div>
            <div class="scorebox" style="margin-top:8px">
              <div class="score"><div class="name">TOTAL</div><div id="sTOTAL" class="val">-</div></div>
              <div class="score"><div class="name">ã‚³ãƒ¼ãƒãƒ³ã‚°</div><div id="sCO" class="val">-</div></div>
              <div class="score"><div class="name">å‚¾è´ãƒ»å…±æ„Ÿ</div><div id="sLI" class="val">-</div></div>
              <div class="score"><div class="name">ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯</div><div id="sTE" class="val">-</div></div>
              <div class="score"><div class="name">æ¬¡ã®ä¸€æ‰‹</div><div id="sNE" class="val">-</div></div>
            </div>
            <p class="hint">â€»ã‚¹ã‚³ã‚¢ã¯æš«å®šçš„ã«ãƒ•ãƒ­ãƒ³ãƒˆã§è¨ˆç®—ï¼ˆå°†æ¥ã¯Edge Functionã¸ç§»è¡Œï¼‰ã€‚</p>

            <div class="row" style="margin-top:8px">
              <button class="btn btn-primary" id="saveBtn">Supabaseã¸ä¿å­˜</button>
              <span class="hint" id="saveStatus"></span>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Supabase SDK â†’ AppShellï¼ˆåŒéšå±¤ï¼‰ -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./app-shell.js"></script>
  <script>
    // App Shellï¼ˆå·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç­‰ï¼‰ã‚’åˆæœŸåŒ–
    AppShell.mountShell();
  </script>

  <!-- è©•ä¾¡ãƒ»ãƒ‘ãƒ¼ã‚¹ãƒ»ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ»ä¿å­˜ -->
  <script>
    // ===== Dify è¨­å®šï¼ˆç¤¾å†…PoCæƒ³å®šï¼šãƒ•ãƒ­ãƒ³ãƒˆç›´æ›¸ãï¼‰=====
    const DIFY_API_BASE = "https://api.dify.ai/v1";
    const DIFY_API_KEY  = "app-oQ6FrskTeh3kjOopzVmm44pq"; // â† ã‚ãªãŸã®Dify App Key

    // ç”»é¢è¦ç´ 
    const els = {
      name:        document.getElementById('name'),
      relation:    document.getElementById('relation'),
      category:    document.getElementById('category'),
      transcript:  document.getElementById('transcript'),
      fileInput:   document.getElementById('fileInput'),
      uploadBtn:   document.getElementById('uploadBtn'),
      uploadStat:  document.getElementById('uploadStatus'),
      startBtn:    document.getElementById('startEvalBtn'),
      statusLine:  document.getElementById('statusLine'),
      resultArea:  document.getElementById('resultArea'),
      qualCards:   document.getElementById('qualCards'),
      saveBtn:     document.getElementById('saveBtn'),
      saveStatus:  document.getElementById('saveStatus'),
      sTOTAL:      document.getElementById('sTOTAL'),
      sCO:         document.getElementById('sCO'),
      sLI:         document.getElementById('sLI'),
      sTE:         document.getElementById('sTE'),
      sNE:         document.getElementById('sNE'),
    };

    // ãƒ©ãƒ³ã‚¿ã‚¤ãƒ çŠ¶æ…‹
    let conversationId = null;
    let lastUploadedFileId = null;

    // ========= SupabaseåˆæœŸåŒ–ã‚’å®‰å…¨ã«å¾…ã¤ =========
    async function getCurrentUserSafe(){
      let tries = 0;
      while (!window.sb && tries < 40) { // æœ€å¤§2ç§’å¾…æ©Ÿï¼ˆ50ms * 40ï¼‰
        await new Promise(r => setTimeout(r, 50));
        tries++;
      }
      if (!window.sb) throw new Error("SupabaseæœªåˆæœŸåŒ–ï¼ˆapp-shell.jsã®èª­ã¿è¾¼ã¿é †ã‚’ç¢ºèªï¼‰");
      const { data:{ user }, error } = await window.sb.auth.getUser();
      if (error) throw error;
      return user;
    }

    // ========= UIãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
    const clamp = (n, min, max)=>Math.max(min, Math.min(max, n));
    function colorize(el, v, max){
      el.textContent = v==null ? "-" : String(Math.round(v));
      el.classList.remove('ok','warn','bad');
      if (v==null) return;
      const r = v/max;
      if (r>=0.8) el.classList.add('ok'); else if (r>=0.5) el.classList.add('warn'); else el.classList.add('bad');
    }
    function makeCard(title, items){
      if(!items || items.length===0) return null;
      const card=document.createElement('div'); card.className='card';
      const body=document.createElement('div'); body.className='body';
      const h=document.createElement('h3'); h.textContent=title; h.style.margin='0 0 6px';
      const ul=document.createElement('ul'); ul.className='clean'; ul.style.paddingLeft='1.2em';
      for(const t of items){ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); }
      body.appendChild(h); body.appendChild(ul); card.appendChild(body);
      return card;
    }
    function renderQualCards(sections){
      els.qualCards.innerHTML='';
      const c1=makeCard('ã€è‰¯ã„ç‚¹âœ¨ã€‘', sections.good);
      const c2=makeCard('ã€ã‚‚ã£ã¨è‰¯ããªã‚‹ç‚¹ğŸ’¡ã€‘', sections.better);
      const c3=makeCard('ã€7ã¤ã®ç¿’æ…£ã®è¦³ç‚¹ğŸ“˜ã€‘', sections.habits);
      [c1,c2,c3].forEach(c => c && els.qualCards.appendChild(c));
      if(!c1 && !c2 && !c3){
        const p=document.createElement('p'); p.className='hint';
        p.textContent='ç‰¹ç­†ã™ã¹ãå®šæ€§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
        els.qualCards.appendChild(p);
      }
    }

    // ========= Difyé€£æº =========
    async function uploadFileToDify(file){
      const form = new FormData();
      form.append('file', file);
      const res = await fetch(`${DIFY_API_BASE}/files`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${DIFY_API_KEY}` },
        body: form
      });
      if(!res.ok) throw new Error(`Difyãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—: ${res.status}`);
      return res.json(); // { id, ... }
    }

    async function callDifyEvaluate({ query, files, userId }){
      const body = {
        inputs: {},
        query,
        user: userId || "demo-user",
        response_mode: "blocking",
        conversation_id: conversationId || undefined,
        files: files || []
      };
      const res = await fetch(`${DIFY_API_BASE}/chat-messages`,{
        method:"POST",
        headers:{ "Authorization":`Bearer ${DIFY_API_KEY}`, "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const text = await res.text();
      if(!res.ok) throw new Error(`Difyè©•ä¾¡ã«å¤±æ•—: ${res.status} ${text}`);
      return JSON.parse(text);
    }

    // ========= ãƒ‘ãƒ¼ã‚¹ï¼ˆJSONã¯è¡¨ç¤ºã—ãªã„ï¼‰ =========
function parseFeedback(text){
  const result = { good: [], better: [], habits: [], values: null };

  // --- â‘  JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¤œå‡ºã—ã¦å–ã‚Šé™¤ã ---
  // ã€Œ===JSON===ã€ä»¥é™ã¾ãŸã¯æœ«å°¾ã® { ... } éƒ¨åˆ†ã‚’å‰Šé™¤
  let cleaned = text;
  if (cleaned.includes("===JSON===")) {
    cleaned = cleaned.split("===JSON===")[0];
  } else {
    const jsonMatch = cleaned.match(/\{[\s\S]*\}$/);
    if (jsonMatch) cleaned = cleaned.replace(jsonMatch[0], "");
  }

  // --- â‘¡ JSONã¯å†…éƒ¨ã§ã ã‘è§£æï¼ˆç”»é¢ã«ã¯å‡ºã•ãªã„ï¼‰---
  try {
    const m = text.split("===JSON===")[1] || (text.match(/\{[\s\S]*\}$/)?.[0] ?? "");
    if (m) {
      const j = JSON.parse(m.trim());
      if (j.values) result.values = j.values;
    }
  } catch { /* ç„¡è¦–OK */ }

  // --- â‘¢ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º ---
  const pick = (label) => {
    const re = new RegExp(`ã€${label}ã€‘([\\s\\S]*?)(?=\\n\\s*ã€|$)`, 'm');
    const m = cleaned.match(re);
    return m ? m[1].trim() : "";
  };

  const toList = (block) => {
    if (!block) return [];
    return block
      .split(/\r?\n/)
      .map(s => s.trim())
      .filter(Boolean)
      .map(s => s.replace(/^(?:ãƒ»|-|\d+\.)\s*/, ""))
      .filter(s => !/è‰¯ã„ç‚¹|ã‚‚ã£ã¨è‰¯ããªã‚‹ç‚¹|7ã¤ã®ç¿’æ…£/.test(s));
  };

  result.good   = toList(pick("è‰¯ã„ç‚¹âœ¨"));
  result.better = toList(pick("ã‚‚ã£ã¨è‰¯ããªã‚‹ç‚¹ğŸ’¡"));
  result.habits = toList(pick("7ã¤ã®ç¿’æ…£ã®è¦³ç‚¹ğŸ“˜"));

  return result;
}

    // ========= ã‚¹ã‚³ã‚¢è¨ˆç®— =========
    function calcScores(values){
      const oq  = Number(values?.open_question_rate ?? 0);
      const st  = Number(values?.subordinate_talk_ratio ?? 0);
      const rc  = Number(values?.reflection_count ?? 0);
      const g   = values?.good || {};
      const b   = values?.bad  || {};
      const nxt = values?.next || {};

      const A = Math.min(20, (oq/0.30) * 20);
      const B = st >= 0.60 ? 20 : 20 * (st/0.60);
      const C = clamp((Number(g.coaching||0) - Number(b.coaching||0)), -20, 20);
      const coaching = clamp(A + B + C, 0, 40);

      const LA = Math.min(30, (rc/3) * 30);
      const LB = clamp((Number(g.listening||0) - 3*Number(b.listening||0)), -20, 6);
      const listening = clamp(LA + LB, 0, 30);

      const technique = clamp(10 + (Number(g.technique||0) - Number(b.technique||0)), 0, 20);

      const next_step = clamp(
        3*(nxt.touched?1:0) + 4*(nxt.what?1:0) + 3*(nxt.when?1:0),
        0, 10
      );

      const total = clamp(coaching + listening + technique + next_step, 0, 100);
      return { coaching:Math.round(coaching), listening:Math.round(listening), technique:Math.round(technique), next_step:Math.round(next_step), total:Math.round(total) };
    }

    // ========= Supabaseï¼ˆappã‚¹ã‚­ãƒ¼ãƒï¼‰ =========
async function getMyAppUserId(){
  const { data:{ user }, error:authErr } = await window.sb.auth.getUser();
  if (authErr || !user) throw new Error("ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã€‚");

  let { data:row } = await window.sb
    .from('users', { schema:'app' })
    .select('user_id')
    .eq('auth_user_id', user.id)
    .maybeSingle();

  if (!row) {
    const ins = await window.sb
      .from('users', { schema:'app' })
      .insert([{ auth_user_id:user.id, email:user.email ?? null, name:user.user_metadata?.full_name ?? null }])
      .select('user_id')
      .single();
    if (ins.error) throw ins.error;
    row = ins.data;
  }
  return row.user_id;
}

    async function createSession({ category, values_json, scores_json }){
      const user_id = await getMyAppUserId();
      const { data, error } = await window.sb
        .from('sessions', { schema: 'app' })
        .insert([{ user_id, category, values_json, scores_json }])
        .select('session_id')
        .single();
      if (error) throw error;
      return data.session_id;
    }
    async function insertFeedback(session_id, { good_points, better_points, seven_habits, raw_json }){
      const { error } = await window.sb
        .from('session_feedbacks', { schema: 'app' })
        .insert([{ session_id, good_points, better_points, seven_habits, raw_json }]);
      if (error) throw error;
    }
    async function insertUsage(session_id){
      const user_id = await getMyAppUserId();
      // å¤±æ•—ã—ã¦ã‚‚è‡´å‘½ã§ã¯ãªã„ã®ã§tryã«ã—ãªã„ï¼ˆä¸Šã«ä»»ã›ã‚‹ï¼‰
      await window.sb
        .from('usage', { schema: 'app' })
        .insert([{ user_id, session_id }]);
    }

    // ========= ã‚¤ãƒ™ãƒ³ãƒˆ =========
    els.uploadBtn.addEventListener('click', async ()=>{
      const f = els.fileInput.files[0];
      if(!f){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      try{
        els.uploadStat.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦';
        const up = await uploadFileToDify(f);
        lastUploadedFileId = up?.id || null;
        els.uploadStat.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº† âœ“';
      }catch(e){
        console.error(e);
        els.uploadStat.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—';
      }
    });

    els.startBtn.addEventListener('click', async ()=>{
      const name      = els.name.value.trim();
      const relation  = els.relation.value.trim();
      const category  = els.category.value.trim();
      const transcript= els.transcript.value.trim();
      if (!name) { alert('æ°åã¯å¿…é ˆã§ã™'); return; }
      if (!transcript && !lastUploadedFileId) { alert('ä¼šè©±ãƒ­ã‚°ã®è²¼ä»˜ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™'); return; }

      try{
        els.statusLine.textContent = 'Difyã¸é€ä¿¡ä¸­â€¦';
        const sbUser = await getCurrentUserSafe();

        const files = [];
        if (lastUploadedFileId){
          files.push({ type:"file", transfer_method:"local", upload_file_id:lastUploadedFileId });
        }

        const query = [
          `æ°åï¼š${name}`,
          relation ? `å‚åŠ è€…ï¼š${relation}` : "",
          category ? `ç¨®åˆ¥ï¼š${category}`   : "",
          transcript ? `ä¼šè©±ãƒ­ã‚°ï¼š\n${transcript}` : ""
        ].filter(Boolean).join("\n\n");

        const data = await callDifyEvaluate({ query, files, userId: sbUser?.id });
        conversationId = data.conversation_id || conversationId;

        // JSONã¯è¡¨ç¤ºã›ãšã€ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æŠ½å‡º
        const answer  = data.answer || "";
        const parsed  = parseFeedback(answer);         // {good, better, habits, values}
        const values  = parsed.values || {};
        const scores  = calcScores(values);

        // å®šæ€§3ã‚«ãƒ¼ãƒ‰ & ã‚¹ã‚³ã‚¢è¡¨ç¤º
        els.resultArea.style.display = 'block';
        renderQualCards(parsed);
        colorize(els.sTOTAL, scores.total, 100);
        colorize(els.sCO,    scores.coaching, 40);
        colorize(els.sLI,    scores.listening, 30);
        colorize(els.sTE,    scores.technique, 20);
        colorize(els.sNE,    scores.next_step, 10);

        // ä¿å­˜ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼šsessions â†’ session_feedbacks â†’ usage
        els.saveStatus.textContent = '';
        els.saveBtn.onclick = async ()=>{
          try{
            els.saveStatus.textContent = 'ä¿å­˜ä¸­â€¦';
            const gp = (parsed.good   || []).map(s=>`ãƒ»${s}`).join('\n') || null;
            const bp = (parsed.better || []).map(s=>`ãƒ»${s}`).join('\n') || null;
            const sh = (parsed.habits || []).map(s=>`ãƒ»${s}`).join('\n') || null;

            const session_id = await createSession({
              category,
              values_json: values,
              scores_json: scores
            });
            await insertFeedback(session_id, {
              good_points: gp,
              better_points: bp,
              seven_habits: sh,
              raw_json: { text: answer }
            });
            await insertUsage(session_id);

            els.saveStatus.textContent = 'ä¿å­˜ã—ã¾ã—ãŸ âœ“';
          }catch(e){
            console.error(e);
            els.saveStatus.textContent = 'ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š' + (e.message || e);
          }
        };

        els.statusLine.textContent = 'è©•ä¾¡å®Œäº†ã€‚å¿…è¦ãªã‚‰ã€Œä¿å­˜ã€ã—ã¦ãã ã•ã„ã€‚';
      }catch(e){
        console.error(e);
        els.statusLine.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + (e.message || e);
      }
    });
  </script>
</body>
</html>
